%/**********   Function   PIM  ****************/
%{
*       Input:  r, error limits  DP \epsilon
*               KI, K_norm Sensihull
*               T, Isotropic Trans Matrix
*               z, real location, 二维行向量
*       Output: z1,  disturbled location   二维行向量
%}
clear all
clc
% %S = [-9 -7; -10 -6; -12 -3; -8 3; -3 7; 9 7; 10 6; 12 3; 8 -3; 3 -7; -9 -7]
%K = [12 3; 10 6; 9 7; 3 7; -3 7; -8 3; -12 -3; -10 -6; -9 -7; -3 -7; 3 -7; 8 -3; 12 3];
p1 = [
 
1.10787e-006,1.07566e-006,9.89839e-007,9.69068e-007,9.41672e-007,1.06819e-006,1.03615e-006,1.03262e-006,9.48472e-007,1.02921e-006,1.01283e-006,1.01091e-006,9.88596e-007,9.35385e-007,1.02378e-006,9.92006e-007,9.96083e-007,1.11046e-006,7.77857e-007,1.17913e-006,1.0078e-006,9.4157e-007,9.36613e-007,1.05439e-006,8.60023e-007,1.03274e-006,1.27413e-006,1.21595e-006,1.02181e-006,9.72084e-007,1.18944e-006,1.04195e-006,1.127e-006,1.40992e-006,8.12804e-007,1.39376e-006,1.01368e-006,1.05383e-006,1.10312e-006,8.92643e-007,1.0168e-006,1.15989e-006,9.19982e-007,1.08684e-006,1.06696e-006,1.10356e-006,1.31138e-006,1.17987e-006,1.03645e-006,9.87477e-007,9.45853e-007,9.14537e-007,9.43508e-007,1.22158e-006,1.05902e-006,1.10861e-006,1.15761e-006,3.34724e-006,8.80895e-007,1.68738e-006,9.09965e-007,1.12326e-006,9.57269e-007,9.97321e-007,2.07307e-006,8.59195e-007,9.78477e-007,8.1308e-007,9.97669e-007,9.34049e-007,1.04061e-006,1.18092e-006,7.91252e-007,1.14642e-006,1.20295e-006,1.2317e-006,1.18097e-006,1.09605e-006,1.10992e-006,1.01489e-006,8.51878e-007,9.71333e-007,8.75643e-007,1.08824e-006,1.13596e-006,1.12771e-006,1.16325e-006,9.88243e-007,1.10539e-006,1.10059e-006,8.0336e-007,1.05586e-006,1.14448e-006,1.10976e-006,9.88044e-007,1.14906e-006,1.01971e-006,1.04952e-006,1.14442e-006,9.89098e-007,1.22024e-006,1.01545e-006,1.19233e-006,1.09738e-006,1.03404e-006,1.20509e-006,8.47423e-007,1.37165e-006,1.14388e-006,1.28866e-006,1.23517e-006,7.97065e-007,9.57471e-007,7.80076e-007,1.01293e-006,3.32495e-006,1.20125e-006,1.36127e-006,1.00972e-006,1.00472e-006,9.98136e-007,1.02247e-006,1.21988e-006,1.235e-006,2.73379e-006,2.37432e-006,9.76048e-007,1.06235e-006,1.1306e-006,8.95321e-007,8.73693e-007,1.07476e-006,1.15974e-006,1.0273e-006,1.04078e-006,8.01448e-007,1.05192e-006,8.04273e-007,1.55242e-006,1.00094e-006,2.83439e-006,1.03906e-006,9.87191e-007,1.15253e-006,8.81578e-007,1.23005e-006,6.6478e-007,1.17896e-006,1.17241e-006,1.14441e-006,9.25168e-007,1.02688e-006,1.22428e-006,1.12793e-006,1.10427e-006,1.6019e-006,1.09586e-006,1.27185e-006,1.08708e-006,9.73962e-007,1.11017e-006,1.24176e-006,9.7421e-007,1.03642e-006,0.0255355,0.0138447,2.19219e-006,1.08415e-006,8.92028e-007,1.11999e-006,9.90027e-007,9.21423e-007,1.76307e-006,1.06822e-006,9.19792e-007,1.10162e-006,1.06681e-006,9.31547e-007,8.34318e-007,1.05466e-006,1.04933e-006,9.80406e-007,1.30898e-006,1.03296e-006,0.040651,0.0419542,1.02487e-006,1.15121e-006,8.46268e-007,1.06192e-006,8.93921e-007,1.09179e-006,9.84819e-007,9.67807e-007,1.53121e-006,9.53378e-007,1.33424e-006,9.37023e-007,7.84133e-007,1.1164e-006,1.29932e-006,9.46309e-007,1.02052e-006,1.04601e-006,0.0521803,0.0177939,2.84199e-006,1.03802e-006,1.16495e-006,9.65305e-007,1.04203e-006,1.05248e-006,1.58199e-006,1.00543e-006,1.04651e-006,1.3654e-006,1.28386e-006,9.42599e-007,1.03487e-006,2.51065e-006,1.12403e-006,1.29984e-006,1.08604e-006,0.00023315,0.0701687,1.0384e-006,1.27766e-006,1.07236e-006,8.94643e-007,9.5911e-007,1.09756e-006,2.4979e-006,1.30566e-006,1.58333e-006,9.79035e-007,1.19262e-006,9.50507e-007,3.3056e-006,9.99236e-007,1.16417e-006,9.94256e-007,8.85163e-007,0.0128845,0.017813,0.0505324,1.04584e-006,9.55226e-007,9.74759e-007,1.02024e-006,1.13106e-006,1.32613e-006,1.08955e-006,9.98263e-007,9.65368e-007,1.07737e-006,1.23787e-006,1.38544e-006,9.38832e-007,1.09818e-006,1.12672e-006,1.25271e-006,9.91126e-007,9.75205e-007,1.00769e-006,0.0403369,8.64093e-007,1.03762e-006,1.05524e-006,1.06866e-006,1.23935e-006,1.02684e-006,1.73895e-006,9.34486e-007,8.80752e-007,1.08037e-006,1.07657e-006,1.12573e-006,1.19437e-006,1.09351e-006,9.90851e-007,1.2195e-006,1.05288e-006,1.00498e-006,1.31306e-006,0.0369321,0.0380877,0.0399157,0.0162433,0.00339393,0.0023397,1.528e-006,1.09514e-006,9.94698e-007,1.05686e-006,1.42313e-006,8.63687e-007,9.98222e-007,1.23447e-006,1.16151e-006,1.31252e-006,1.08579e-006,1.11024e-006,1.11918e-006,1.10199e-006,9.43802e-007,0.00606891,0.00023499,0.0186215,0.0126887,0.0192806,0.0253554,0.0218156,0.0368639,2.49228e-006,9.81627e-007,1.16832e-006,9.09471e-007,1.0187e-006,9.29919e-007,9.18388e-007,2.78429e-006,1.02373e-006,1.12091e-006,1.28687e-006,2.15597e-006,1.0783e-006,0.00782897,0.0107837,1.33709e-006,1.09741e-006,1.22743e-006,8.41337e-007,0.0249319,1.12399e-006,1.03813e-006,9.1064e-007,1.30077e-006,1.01772e-006,1.1807e-006,1.3824e-006,1.062e-006,1.32206e-006,1.41007e-006,1.61478e-006,9.73595e-007,1.05137e-006,1.11974e-006,0.0184943,9.22982e-007,1.23813e-006,1.17405e-006,1.13994e-006,0.0418546,9.98786e-007,1.14698e-006,1.05581e-006,1.10391e-006,8.7593e-007,1.17839e-006,1.53743e-006,1.03714e-006,1.25468e-006,1.56526e-006,1.45254e-006,1.00626e-006,1.0726e-006,8.35994e-007,0.0170268,0.0144533,0.0351417,0.0310793,0.0419531,0.0725239,1.20344e-006,1.12869e-006,1.06358e-006,1.11716e-006,1.18887e-006,1.01623e-006,1.60999e-006,9.50091e-007,9.08622e-007,1.09751e-006,1.02088e-006,1.10429e-006,1.10762e-006,9.32282e-007,0.00315752,0.00358548,0.0103042,1.23683e-006,9.6879e-007,0.00469976,1.04837e-006,1.07296e-006,1.04745e-006,9.45258e-007,1.06638e-006,1.02122e-006,1.0347e-006

];       %先验概率, 实际位置发生概率

z = [0, 0];
s = 0.05;
r = 1;      %epsilon

S = DeltaSet(p1, s);       %delta 集

K = Sshull (S);            %sensitivity hull

[a, T] = Isotropictrans(  K );

KI = (T*(K'))';

y = PIM(r, KI, T, z);            % 扰动位置  释放的位置

p = PRelease_V(r, KI, T, y, p1);

p3 = PostUpdate(p1, p);



%     n = length(S);
%     for i = 1: n
%         a(i) = S(i, 1);
%         b(i) = S(i, 2);
%     end
%     
% %    plot(a, b)
%  S1 = convhull(a', b')

% n = length(S1);
% for i = 1: n
%     a2(i) = S(S1(i), 1);
%     b2(i) = S(S1(i), 2);
% end
% plot(a2, b2,'r')
% hold on;

%
% p0 = [-14.0039, 15.5221];
% d = [0.2669, 0.6417];
% Ip = Intersecpoint( p0, d, K)








% % % %把 Sensihull 转化为 等向平面
% % % % T = Isotropictrans(  K )
% T = [0.1844 -0.0400; -0.0400 0.2802];
% KI = (T*(K'))';

 


% 
% z1 = (T*(z'))';
% z0 = [0, 0];
% y1 = (T*(y'))';
% S =  SSarea(KI);
%  
% d = y1 - z1;
% Ip = Intersecpoint(z0, d, KI);
% 
% %x = [0, 0];
% if Ip(1, 1)*d(1) > 0
%     x = Ip(1, :);
% elseif Ip(1, 2)*d(2) > 0
%     x = Ip(1, :);
% else 
%     x = Ip(2, :);
% end
% 
% if d(1) == 0
%     s = x(2)/d(2);
% else
%     s = x(1)/d(1);
% end
% 
% p = (r^2)/(2*S)* exp(-r*s);
% end



% n = length(S);
% for i = 1: n
%     a(i) = S(i, 1);
%     b(i) = S(i, 2);
% end
% plot(a, b)
% hold on;
% n = length(KI);
% for i = 1: n
%     a1(i) = KI(i, 1);
%     b1(i) = KI(i, 2);
% end
% plot(a1, b1)
% plot(zt(1), zt(2),'b+')
% plot(z1(1), z1(2),'r*')

